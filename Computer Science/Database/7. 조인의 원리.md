# 4.7 조인의 원리

## **개요**
조인의 원리의 종류와 동작 방법 및 특징에 대해서 알아봅니다.

## **목차**

<!-- TOC -->

- [조인의 원리](#%EC%A1%B0%EC%9D%B8%EC%9D%98-%EC%9B%90%EB%A6%AC)
    - [**개요**](#%EA%B0%9C%EC%9A%94)
    - [**목차**](#%EB%AA%A9%EC%B0%A8)
    - [중첩 루프 조인NL Join, Nested Loop Join](#%EC%A4%91%EC%B2%A9-%EB%A3%A8%ED%94%84-%EC%A1%B0%EC%9D%B8nl-join-nested-loop-join)
    - [정렬 병합 조인Sort Merge Join](#%EC%A0%95%EB%A0%AC-%EB%B3%91%ED%95%A9-%EC%A1%B0%EC%9D%B8sort-merge-join)
    - [해시 조인Hash Join](#%ED%95%B4%EC%8B%9C-%EC%A1%B0%EC%9D%B8hash-join)
    - [**참고 자료**](#%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C)

<!-- /TOC -->

---

## 중첩 루프 조인(NL Join, Nested Loop Join)

- 개념
    - 프로그래밍에서 사용하는 중첩된 반복문과 유사한 방식으로 수행되는 조인이다.
    - 반복문의 외부에 있는 테이블을 선행 테이블 또는 외부 테이블 (Outer Table)이라고 하고, 반복문의 내부에 있는 테이블을 후행 테이블 또는 내부 테이블(Inner Table)이라고 한다.

- 동작

    <img alt="NL Join(Nested Loop Join)" width=400 src="https://github.com/OhHaneol/basic-computer-science/assets/62991586/eb4fb534-1097-40ff-9218-782868027714">


    1. 선행 테이블에서 조건을 만족하는 첫 번째 행을 스캔한다.
        - 이 때 선행 테이블에 주어진 조건을 만족하지 않는 경우 해당 데이터는 필터링한다.

    2. 선행 테이블의 조인 키를 가지고 후행 테이블에 조인키가 존재하는지 스캔한다.
        - 조인을 시도한다.

    3. 후행 테이블의 인덱스에 선행 테이블의 조인 키가 존재하는지 확인한다.
        - 선행 테이블의 조인 값이 후행 테이블에 존재하지 않으면 선행 테이블 데이터는 필터링한다. (더 이상 조인 작업을 진행할 필요 없음)
    
    4. 인덱스에서 추출한 레코드(행) 식별자를 이용하여 후행 테이블을 액세스한다.
        - 인덱스 스캔을 통해 테이블에 액세스한다.

    5. 후행 테이블에 주어진 조건까지 모두 만족하면 해당 행을 추출버퍼(결괏값)에 넣는다.

- 특징
    - 절차적이며, 프로그래밍에서 FOR, WHILE문 과 같은 구조로 수행된다.
    - 선행테이블은 풀스캔한다.
    - 후행테이블에 대해서는 반드시 인덱스가 존재해야 NL 조인이 가능하다.
    - 인덱스 구성 전략이 특히 중요하다. 조인 컬럼에 대한 인덱스의 유무와, 있다면 컬럼이 어떻게 구성되었는지에 따라 조인 효율이 크게 달라진다.
    - 랜덤 액세스 방식으로 데이터를 읽는다.
        - 랜덤 접근에 대한 비용이 많이 증가하므로 대용량의 테이블에서는 사용하지 않는다.
        - 처리 범위가 좁은 것이 유리하다.

- 장점
    - 소량의 데이터를 주로 처리하거나 부분범위처리가 가능한 온라인 트랜잭션 환경에 적합한 조인 방식이다.
    - 선행테이블은 풀스캔하므로, 선행테이블의 크기가 작을수록 유리하다. 따라서 두 테이블의 크기 차이가 있는 경우 유리하게 사용될 수 있다.

## 정렬 병합 조인(Sort Merge Join)

- 개념
    - 조인 컬럼을 기준으로 데이터를 정렬한 뒤에 조인 작업을 수행하는 조인이다.

- 동작

    <img alt="Sort Merge Join" width=400 src="https://github.com/OhHaneol/basic-computer-science/assets/62991586/9cbd6318-4b39-420e-88ea-fbfd06b50962">


    1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾는다.

    2. 선행 테이블의 조인 키를 기준으로 정렬작업을 수행한다.

    - 1 ~ 2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행한다.

    3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾는다.

    4. 후행 테이블의 조인 키를 기준으로 정렬 작업을 수행한다.

    - 3 ~ 4번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행한다.

    5. 정렬된 결과를 이용하여 조인을 수행하며 조인에 성공하면 추출버퍼(결괏값)에 넣는다.

- 특징
    - **인덱스가 존재하지 않을 경우**에도 가능한 조인법이다.
    - 두 테이블의 사이즈가 비슷한경우에 유리하며, 사이즈 차이가 큰 경우에는 비효율적인 방법이다.
        - 어느 한 쪽이라도 정렬 작업이 종료되지 않으면 조인이 시작될 수 없으므로 두 테이블 조인 집합의 크기가 많이 차이가 난다면 한쪽에 '대기' 상태가 발생하여 비효율적으로 처리가 된다.
        - 이렇게 크기가 비슷하지 않은 집합의 조인을 위해서 HASH 조인을 사용할 수 있다.
    - 스캔 방식으로 데이터를 읽는다.
        - 랜덤 액세스로 NL Join에서 부담이 되던 넓은 범위의 데이터를 처리할 때 이용된다.
        - 그러나 정렬할 데이터가 많아 메모리에서 모든 정렬 작업을 수행하기 어려운 경우에는 임시 영역(디스크)을 사용하기 때문에 성능이 떨어질 수 있습니다.

- 장점
    - 일반적으로 대량의 조인 작업에서 성능상 유리하다.
    - 대부분 해시 조인 보다 느린 성능을 보이나, 아래와 같은 상황에서는 정렬 병합 조인이 유용하다.
        - 선행 테이블에 소트연산을 대체할 인덱스가 있을 때
        - 조인할 선행 테이블이 이미 정렬되어 있을 때
        - 조인 조건식이 등차(=)조건이 아닐 때
    - 메모리 사용이 큰 대용량 테이블 조인시 메모리 외에 임시영역(PGA 메모리)까지 사용하여 저장할 수 있어 유리하다.

## 해시 조인(Hash Join)

- 개념
    - 해싱 기법을 이용하여 조인하는 방법이다.
    - 조인될 두 테이블 중 하나를 해시 테이블로 선정하여 조인될 테이블의 조인 키 값을 Hash 알고리즘으로 비교하여 매치되는 결과값을 얻는 방식이다.
        - 보통 바이트가 더 작은 테이블을 해시 테이블로 선정한다.

- 동작

    <img alt="Hash Join" width=400 src="https://github.com/OhHaneol/basic-computer-science/assets/62991586/fbf77f48-e45a-4fd3-9e9c-e7ec37ea8026">

    - 해시 조인의 단계는 빌드, 프로브 단계로 나뉜다.

    - 빌드 단계
        1. 선행 테이블에서 주어진 조건을 만족하는 행을 찾는다.

        2. 선행 테이블의 조인 키를 기준으로 해시함수를 적용하여 해시 테이블을 생성한다.
            - 조인에 사용되는 필드가 해시 테이블의 키로 사용된다.
            - 여기서 선행 테이블 A의 키를 `A.key_id`라고, 후행 테이블을 B라고 해보자.

        - 1 ~ 2번 작업을 선행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행한다.
    
    - 프로브 단계

        3. 후행 테이블에서 주어진 조건을 만족하는 행을 찾는다.

        4. 후행 테이블의 조인 키를 기준으로 해시 함수를 적용하여 해당 레코드를 찾는다.
            - 해시 테이블에서 후행 테이블 B 의 키 `B.key_id`에 일치하는 행(레코드)을 찾는다.

        5. 조인에 성공하면 추출버퍼(결괏값)에 넣는다.

        - 3 ~ 5번 작업을 후행 테이블의 조건을 만족하는 모든 행에 대해 반복 수행한다.

- 특징
    - 조인 칼럼의 인덱스를 사용하지 않기 때문에 조인 칼럼의 **인덱스가 존재하지 않을 경우**에도 사용할 수 있는 기법이다.
    - **비용 기반 옵티마이저**를 사용할 때만 사용될 수 있는 조인 방식이다.
    - 해쉬 함수를 이용하여 조인을 수행하기 때문에 '=' 비교를 통한 조인에서만 사용될 수 있다.
        > **비용 기반 옵티마이저** : 처리 비용이 가장 적은 실행계획을 선택하는 방식으로, 비용을 예측하기 위해서 테이블, 인덱스, 컬럼 등의 다양한 객체 통계 정보와 시스템 통계 정보를 이용한다.

- 장점
    - 대량의 조인 작업에 주로 사용된다.
    - 메모리 사용이 큰 대용량 테이블 조인시 메모리 외에 임시영역(PGA 메모리)까지 사용하여 저장할 수 있어 유리하다.

---

## **참고 자료**

- 관련 서적
    - [면접을 위한 CS 전공지식 노트(주홍철)](https://product.kyobobook.co.kr/detail/S000001834833?utm_source=google&utm_medium=cpc&utm_campaign=googleSearch&gt_network=g&gt_keyword=&gt_target_id=aud-901091942354:dsa-435935280379&gt_campaign_id=9979905549&gt_adgroup_id=132556570510&gad_source=1&gclid=Cj0KCQjwwYSwBhDcARIsAOyL0fhby9LTtW8HLZ5Wg0aW9oKf_EyHPNtAttNCtkeyvmU4HlWw4sGx6VYaAnT5EALw_wcB)
- 블로그
    - [SQL 조인(Join) 수행 원리 (NL Join, Sort Merge Join, Hash Join)](https://velog.io/@eunhye_/SQL-%EC%A1%B0%EC%9D%B8Join-%EC%88%98%ED%96%89-%EC%9B%90%EB%A6%AC)
    - [비용 기반 옵티마이저](https://sengwoolee.dev/88)
- 이미지 출처
    - [NL Join(Nested Loop Join)](https://velog.io/@eunhye_/SQL-%EC%A1%B0%EC%9D%B8Join-%EC%88%98%ED%96%89-%EC%9B%90%EB%A6%AC)
    - [Sort Merge Join](https://velog.io/@eunhye_/SQL-%EC%A1%B0%EC%9D%B8Join-%EC%88%98%ED%96%89-%EC%9B%90%EB%A6%AC)
    - [Hash Join](https://velog.io/@eunhye_/SQL-%EC%A1%B0%EC%9D%B8Join-%EC%88%98%ED%96%89-%EC%9B%90%EB%A6%AC)
