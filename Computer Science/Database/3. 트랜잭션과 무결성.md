# 4.3 트랜잭션과 무결성

## **개요**
트랜잭션의 ACID 특징과 무결성에 대해서 알아봅니다.

## **목차**

<!-- TOC -->

- [트랜잭션과 무결성](#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98%EA%B3%BC-%EB%AC%B4%EA%B2%B0%EC%84%B1)
    - [**개요**](#%EA%B0%9C%EC%9A%94)
    - [**목차**](#%EB%AA%A9%EC%B0%A8)
    - [트랜잭션](#%ED%8A%B8%EB%9E%9C%EC%9E%AD%EC%85%98)
        - [원자성](#%EC%9B%90%EC%9E%90%EC%84%B1)
            - [커밋과 롤백](#%EC%BB%A4%EB%B0%8B%EA%B3%BC-%EB%A1%A4%EB%B0%B1)
        - [일관성](#%EC%9D%BC%EA%B4%80%EC%84%B1)
        - [격리성](#%EA%B2%A9%EB%A6%AC%EC%84%B1)
        - [지속성](#%EC%A7%80%EC%86%8D%EC%84%B1)
    - [무결성](#%EB%AC%B4%EA%B2%B0%EC%84%B1)
    - [**참고 자료**](#%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C)

<!-- /TOC -->

---

## 트랜잭션

- 개념
    - 데이터베이스에서 하나의 논리적 기능을 수행하기 위한 작업의 단위이자, **쪼갤 수 없는 업무의 최소 단위**를 의미한다.
    - (데이터베이스에 접근하는 방법은 쿼리이므로)여러 개의 쿼리들을 하나로 묶는 단위를 말한다.
- ACID 특징

    <img alt="ACID 특징" src="">

    - Atomicity: 원자성
    - Consistency: 일관성
    - Isolation: 격리성
    - Durability: 지속성

### 원자성

- 개념
    - 트랜잭션과 관련된 일이 모두 수행되었거나 어떤 부분도 수행되지 않거나 둘 중 하나를 보장하는 특징이다.
- 예시
    - 스트리밍 데이터 소스가 스트리밍 중에 갑자기 오류를 일으키더라도 데이터 손실과 손상이 방지됩니다.
    - 예금 이체 등의 과정에서 도중에 작업을 취소하더라도 변경이 일어나지 않습니다.
- 주의점
    - 트랜잭션 단위로 여러 로직을 묶을 때, 외부 API를 호출하는 것이 있으면 안 된다.
    - 만약 있다면 롤백이 일어났을 상황에 대한 해결 방법이 있어야 하고, **트랜잭션 전파**를 신경 써서 관리해야 한다.
        > **트랜잭션 전파**: 여러 트랜잭션 관련 메서드의 호출을 하나의 트랜잭션에 묶이도록 하는 것을 의미한다. Spring 프레임워크의 경우 @Transactional 애너테이션을 통해 여러 쿼리 관련 코드를 하나의 트랜잭션으로 처리한다.

#### 커밋과 롤백

- 커밋 개념
    - 여러 쿼리가 성공적으로 처리되었다고 확정하는 명령어로, 트랜잭션 단위로 수행되며 변경된 내용이 **모두 영구적으로 저장**되는 것을 의미한다.
- 롤백 개념
    - 트랜잭션으로 처리한 하나의 묶음 과정을 (에러나 이슈 때문에)일어나기 전으로 돌리는 일(취소)을 의미한다.
- 의의
    - 커밋과 롤백으로 인해 데이터의 무결성이 보장된다.
    - 데이터 변경 전에 변경 사항을 쉽게 확인 가능하다.
    - 해당 작업을 그룹화할 수 있다.

### 일관성

- 개념
    - '허용된 방식'으로만 데이터를 변경해야 하는 것을 의미한다.
    - 쉽게 말 해 규칙을 따르는 것을 의미한다.

### 격리성

- 개념
    - 트랜잭션 수행 시 서로 끼어들지 못하는 것을 의미한다.
- 의의
    - 복수의 병렬 트랜잭션의 경우 서로 격리되어 마치 순차적으로 실행되는 것 처럼 작동되어야 하고, 데이터베이스는 여러 사용자가 같은 데이터에 접근할 수 있어야 한다.
    - 이 경우 순차적으로 접근하면 쉽지만 성능이 나쁘다는 문제가 발생하는데, 여러 개의 격리 수준으로 이를 관리하여 격리성을 보장한다.
- 격리 수준
    - 레벨이 올라갈수록 격리성은 강해지고 동시성은 약해진다.
    - Read Uncommitted (Level 0)
        - 어떤 트랜잭션의 내용이 **커밋이나 롤백과 상관없이 다른 트랜잭션에서 조회가 가능**하다.
        - 정합성의 문제가 많은 격리 수준이기 때문에 RDBMS 표준에서는 격리수준으로 인정하지 않는다.
    - Read Committed (Level 1)
        - 한 트랜잭션의 변경내용이 **커밋(Commit) 완료 되어야만 다른 트랜잭션에서 조회가 가능**하다.
        - 대부분의 RDBMS에서 기본적으로 사용하는 격리수준이다.
    - Repeatable Read (Level 2)
        - 트랜잭션이 시작되기 전에 커밋된 내용에 대해서만 조회가 가능하다.
        - 하나의 트랜잭션이 수정한 행을 다른 트랜잭션이 수정할 수 없도록 막아주지만, 새로운 행을 추가하는 것은 막지 않는다.
        - MySQL에서 기본으로 사용한다.
    - SERIALIZABLE (Level 3)
        - 트랜잭션들이 동시에 일어나지 않고 순차적으로 실행되는 것처럼 동작한다.
        - 가장 단순하면서 엄격한 격리 수준이지만 성능 측면에서는 동시 처리 성능이 가장 낮아 거의 사용되지 않는다.
- 격리 수준에 따라 발생하는 현상
    - 팬텀 리드(Phantom Read)
        - 다른 트랜잭션이 커밋한 데이터가 있더라도 자신의 트랜잭션에서 읽었던 내용만 사용하는 것을 의미한다.
        - 즉, 한 트랜잭션에서 같은 쿼리를 2번이상 조회했을 때 없던 결과가 조회되는 상황을 말한다.
        - 보통 데이터의 삽입이 발생했을 경우 발생한다.
    - 반복 가능하지 않은 조회(Non-repeatable Read)
        - 다른 트랜잭션이 커밋한 데이터를 읽을 수 있는 것을 의미한다.
        - 즉, 한 트랜잭션에서 같은 쿼리로 2번이상 조회했을 때 그 결과가 상이한 상황을 말한다.
        - 보통 데이터의 수정/삭제가 발생했을 경우 발생한다.
    - 더티 리드(Dirty Read)
        - 아직 커밋(Commit)되지 않은 다른 트랜잭션의 데이터를 읽는 것을 의미한다.

### 지속성

- 개념
    - 성공적으로 수행된 트랜잭션은 영원히 반영되어야 함을 의미한다.
    - 다시 말 해 데이터베이스에 시스템 장애가 발생해도 원래 상태로 복구하는 회복 기능이 있어야 함을 의미한다.
- 지속성을 위해 DB가 제공하는 기능
    - **체크섬**, **저널링**, 롤백 등
        > - **체크섬**: 중복 검사의 한 형태로, 오류 정정을 통해 송신된 자료의 무결성을 보호하는 단순한 방법
        > - **저널링**: 파일 시스템 또는 데이터베이스 시스템에 변경 사항을 반영(커밋)하기 전에 로깅하는 건(트랜잭션 등 변경 사항에 대한 로그를 남기는 것)

## 무결성

- 개념
    - 데이터의 정확성, 일관성, 유효성을 유지하는 것을 말한다.
- 의의
    - 무결성이 유지돼야 하는 이유는, 데이터베이스에 저장된 데이터 값과 그 값에 해당하는 현실 세계의 실제 값이 일치하는지에 대한 신뢰가 생기기 때문이다.
- 종류
    - 개체 무결성: 기본키로 선택된 필드는 빈 값을 허용하지 않는다.
    - 참조 무결성: 서로 참조 관계에 있는 두 테이블의 데이터는 항상 일관된 값을 유지해야 한다.
    - 고유 무결성: 특정 속성에 대해 고유한 값을 가지도록 조건이 주어진 경우, 그 속성 값은 모두 고유한 값을 가진다.
    - NULL 무결성: 특정 속성 값에 NULL이 올 수 없다는 조건이 주어진 경우 그 속성 값은 NULL이 될 수 없다는 제약 조건이다.

---

## **참고 자료**

- 관련 서적
    - [면접을 위한 CS 전공지식 노트(주홍철)](https://product.kyobobook.co.kr/detail/S000001834833?utm_source=google&utm_medium=cpc&utm_campaign=googleSearch&gt_network=g&gt_keyword=&gt_target_id=aud-901091942354:dsa-435935280379&gt_campaign_id=9979905549&gt_adgroup_id=132556570510&gad_source=1&gclid=Cj0KCQjwwYSwBhDcARIsAOyL0fhby9LTtW8HLZ5Wg0aW9oKf_EyHPNtAttNCtkeyvmU4HlWw4sGx6VYaAnT5EALw_wcB)
- 블로그
    - [격리 수준](https://akasai.space/db/about_isolation/)
- 이미지 출처
    - [ACID 특징](https://cloudedi.tistory.com/18)